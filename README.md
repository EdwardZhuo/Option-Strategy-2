# assignment2

策略是由双卖策略改进而来。

1.从IFind API 读取历史行情，然后通过期权收盘价和标的资产收盘价用牛顿迭代法计算波动率。

需要注意的是，由于期权比较虚值的合约会因为长时间没有成交，导致收盘价偏离实际价值过多，此时用牛顿迭代法不一定能得到解，为应对这种情况，特根据最近行情，当期权为深度虚值且无法得到解时，用0.2作为默认波动率，当期权为深度实值且无法得到解时，用0.01作为默认波动率。得到波动率后，计算相应的Greeks值，主要计算的是delta及deltacash；另外由于偏向近月合约，因此对于超出一定时间区间的数据予以忽略，主要措施为设置一个超长的到期天数，使得计算出来的delta很大，因此在下面进行回测设置阈值时可以被程序自动跳过。

2.将所有合约行情文件合并到一个csv，横向合并。

3.通过自己编写的回测程序，设定阈值，进行回测。该程序可以自定义开仓参数，平仓参数，同时可以进行不同时间频率的回测（在1中读取1分钟的数据，到3就是1分钟的回测；在1中读取60分钟的数据，到3就是60分钟的回测）。

首先将数据读入，然后计算总行数和总列数，用总列数除以每个产品占据的列数大小，得到产品数量，总行数则为回测的“循环数”，从第一行一直循环到最后一行。

循环体开始先判断是否有持仓，若无持仓，通过读取第一行数据中所有的deltacash，筛选出合适区间的deltacash，然后从筛选出来的deltacash中选取最大的deltacash（正值，call option）和最小的deltacash（负值，put option），然后进行组合构建：deltacash为0，数量为某固定值（程序中为200）。将得到的结果取整，便得到相应的call option 和put option 的分别卖出数量，最后调用position.py里面的方法，记录卖出合约和数量，并留存日志，然后进行下一行循环。

若有持仓，则程序会判断是否符合阈值，符合则跳过本次循环，开始下一次循环。不符合则全部平仓，然后跳过本次循环，开始下一次循环。这里不考虑交易成本，所以用的是先全部平仓再重新构建组合的方式进行调仓处理，这样的好处是比较简单直接，但相应地比较简陋，最重要的因素是未考虑手续费，后续如果要考虑手续费，需要进行现有持仓和待构建组合的比较，进行净值平仓开仓，然后记录手续费信息。